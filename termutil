#!/bin/bash

BOX_NW=$'\u250C'
BOX_NE=$'\u2510'
BOX_SW=$'\u2514'
BOX_SE=$'\u2518'
BOX_HO=$'\u2500'
BOX_VE=$'\u2502'

get_date()
{
    date +"%H:%M:%S %Z %a %d/%m/%Y"
}

bar()
{
    local bar_char
    if [ "$#" -eq 2 ]; then
	bar_char="$2"
    else
	bar_char="$BOX_HO"
    fi

    for ((i=0; i<${#1}; i++)); do
        printf "%s" "$bar_char"
    done
}

days-in-month()
{
    local days
    case $1 in
    01|03|05|07|08|10|12) days=31 ;;
    04|06|09|10)          days=30 ;;
    02)                   days=28 ;;
    *)                    days="" ;;
    esac
    echo $days
}

first-of-month()
{
    date -d "$(date +%Y)-$1-01" +%u
}

calendar()
{
    local header=$(date +"%_B %Y")
    local cur_month=$(date +%m)
    local days=$(days-in-month $cur_month)
    local fotm=$(first-of-month $cur_month)
    local today=$(date +%-d)
    printf "    %9s\n" "$header"
    echo "--------------------"
    echo " S  M  T  W  T  F  S"
    for ((i=0; i<$(($fotm%7)); i++)); do
        echo -n "   "
    done
    printf " 1"
    for ((d=2; d<=$days; d++)); do
        if [ $(((d-1)%7)) -eq 0 ]; then
            printf "\n"
	else
            printf " "
	fi	
        if [ "$d" == "$today" ]; then
	    printf "\033[92m%2d\033[0m" "$d" 
        else
	    printf "%2d" "$d" 
	fi
    done
    printf "\n"
}

cat2d()
{
    temp="$1.tmp"
    cat "$@" >"$temp"
    longest_line=$(awk 'length > max { max = length; longest = $0 } END { printf longest }' "$temp")
    echo "$BOX_NW$BOX_HO$(bar "$longest_line")$BOX_HO$BOX_NE"
    line_box="$BOX_VE $(bar "$longest_line" " ") $BOX_VE"
    line_undo="$(bar "  $longest_line" $'\b')"
    awk -v v1="$line_box" -v v2="$line_undo" '{printf "%s%s%s\n", v1, v2, $0 }' "$temp"
    echo "$BOX_SW$BOX_HO$(bar "$longest_line")$BOX_HO$BOX_SE"
    rm "$temp"
}

hud()
{
    stty -echo
    printf "\033[?25l"
    clear

    get_date | cat2d

    calendar | cat2d

    local last_d=$(date +%d)
    while true
    do
        read -t 0.1 -n 1 key
        if [[ $key ]]; then
            clear
            stty echo
            printf "\033[?25h"
            break
        fi

        printf "\033[2;3H$(get_date)"
        if [ "$(date +%d)" -ne "$last_d" ]; then
            calendar | cat2d
	fi
        last_d=$(date +%d)
        sleep 0.1
    done
    printf "\033[?25h"
}
